# C2 Detection - Command & Carol

## Overview
In this room, we explored **RITA (Real Intelligence Threat Analytics)**, an open-source framework designed to detect Command and Control (C2) channels and beaconing activity.

We learned how to process raw network traffic (PCAP) into structured logs using **Zeek**, and then import those logs into RITA to identify malicious patterns such as long connections, beaconing, and DNS tunneling.

---

## Key Concepts

### What is RITA?
RITA is a framework by Active Countermeasures that analyzes network traffic to find "evil" that traditional firewalls and IDSs might miss.
* **Core Features:** Detects C2 beacons, long connections, and DNS tunneling.
* **Input:** It requires structured logs generated by **Zeek**.



### What is Zeek?
Zeek (formerly Bro) is a Network Security Monitoring (NSM) tool.
* **Function:** It sits on a network tap or SPAN port and converts raw packets into readable, tab-separated logs (e.g., `conn.log`, `dns.log`, `http.log`).
* **Why we use it:** RITA cannot read raw PCAP files directly; it needs Zeek to "translate" them first.

### Threat Modifiers (Indicators of Compromise)
RITA scores connections based on several anomalies:
* **Beaconing:** Periodic connections (e.g., malware "phoning home" every 5 seconds).

* **Long Connections:** Connections that stay open for hours/days (common in C2 channels).
* **DNS Tunneling:** High volume of subdomains for a single domain (exfiltrating data via DNS queries).

* **Prevalence:** How many internal hosts are talking to a specific external IP. (Low prevalence = suspicious).

---

## Technical Investigation

### Step 1: Converting PCAP to Zeek Logs
We started with a raw packet capture file (`AsyncRAT.pcap`). We used Zeek to parse this file into structured logs.
**Command:**
```bash
zeek readpcap pcaps/AsyncRAT.pcap zeek_logs/asyncrat
```
**Result:** This generated several log files (`conn.log`, `dns.log`, etc.) in the output directory.

### Step 2: Importing into RITA
Next, we imported these logs into the RITA database for analysis.
**Command:**
```bash
rita import --logs ~/zeek_logs/asyncrat/ --database asyncrat
```
### Step 3: Analyzing the Data
We viewed the results using the RITA viewer.

**Command:**
```bash
rita view asyncrat
```
**Findings:**
* **Malicious Domain:** `sunshine-bizrate-inc-software[.]trycloudflare[.]com` (Flagged as malicious by VirusTotal).
* **Malicious IP:** `91.134.150.150` (Flagged as C2).
* **Anomaly:** High beacon score and long connection duration on non-standard ports.

### Step 4: The Challenge (Hunting "Malhare")
We applied these techniques to a new capture (`rita_challenge.pcap`) to answer specific questions about the `malhare.net` domain.

---

## Answers Summary

| Question | Answer |
| :--- | :--- |
| How many hosts are communicating with `malhare.net`? | `6` |
| Which Threat Modifier tells us the number of hosts communicating to a certain destination? | `prevalence` |
| What is the highest number of connections to `rabbithole.malhare.net`? | `40` |
| Which search filter finds entries for `rabbithole.malhare.net` with beacon score > 70%? | `dst:rabbithole.malhare.net beacon:>=70 sort:duration-desc` |
| Which port did the host 10.0.0.13 use to connect to `rabbithole.malhare.net`? | `80` |

---

## Lessons Learned
* **Logs over Raw Packets:** Analyzing 1GB of PCAP is slow. Analyzing 5MB of Zeek logs derived from that PCAP is instant.
* **Beaconing Analysis:** Malware rarely behaves randomly. It follows a heartbeat (beacon). Tools like RITA are essential because humans cannot easily spot a 5-second interval in thousands of packets.

* **Prevalence:** If only one computer in your entire office is talking to a strange server in a foreign country, that is a high-fidelity alert.

---
> **Key Takeaway**: C2 (Command & Control) traffic often hides in plain sight. By analyzing statistical patterns (timing, frequency, data size) rather than just signatures, we can detect even unknown malware.
